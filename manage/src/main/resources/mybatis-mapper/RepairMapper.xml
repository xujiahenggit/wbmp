<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bank.manage.dao.RepairDao">

    <insert id="saveWorkOrder" parameterType="com.bank.manage.dto.WorkOrderDto">
           insert into t_work_order(
              terminal_code,
              work_order_type,
              priority_code,
              director,
              requir_complete_time,
              work_order_describe,
              describe_type,
              work_order_code,
              work_order_status,
              create_time,
              create_id,
              create_name

           )
            values(
             #{terminalCode},
             #{workOrderType},
             #{priorityCode},
             #{director},
             #{requirCompleteTime},
             #{workOrderDescribe},
             #{describeType},
             #{workOrderCode},
             #{workOrderStatus},
             #{createTime},
             #{createId},
             #{createName}
            )

    </insert>

    <insert id="saveInspectionWorkOrder" parameterType="com.bank.manage.dto.InspectionWorkOrderDto">
           insert into t_work_order(
              terminal_code,
              work_order_type,
              escorts_patrol,
              escorts_start_time,
              escorts_complete_time,
              escorts_handling,
              work_order_code,
              work_order_status,
              create_time,
              create_id,
              create_name

           )
            values(
             #{terminalCode},
             #{workOrderType},
             #{escortsPatrol},
             #{startTime},
             #{endTime},
             #{json},
             #{workOrderCode},
             #{workOrderStatus},
             #{createTime},
             #{createId},
             #{createName}
            )

    </insert>

    <insert id="saveComplaintsWorkOrder" parameterType="com.bank.manage.dto.ComplaintsWorkOrderDto">
           insert into t_work_order(
              work_order_type,
              branch,
              sub_branch,
              buffet_line,
              vendor,
              work_order_code,
              work_order_status,
              work_order_describe,
              create_time,
              create_id,
              create_name

           )
            values(
             #{workOrderType},
             #{branch},
             #{subBranch},
             #{buffetLine},
             #{vendor},
             #{workOrderCode},
             #{workOrderStatus},
             #{workOrderDescribe},
             #{createTime},
             #{createId},
             #{createName}
            )

    </insert>


    <insert id="saveRepair" parameterType="com.bank.manage.dos.RepairDo">
        insert into t_work_order
        (terminal_code,
        work_order_type,
        priority_code,
        module_code,
        requir_complete_time,
        create_id,
        work_order_code,
        work_order_status,
        work_order_describe,
        director,
        engineer,
        work_order_complete_time,
        describe_type,
        rating,
        rating_note,
        deal_type,
        deal_note,
        create_time,
        escorts_patrol,
        escorts_start_time,
        escorts_complete_time,
        escorts_handling,
        escorts_handling,
        branch,
        sub_branch,
        buffet_line,
        vendor
        )
        values(
         #{terminalCode},
         #{workOrderType},
         #{priorityCode},
         #{moduleCode},
         #{requirCompleteTime},
         #{createId},
         #{workOrderCode},
         #{workOrderStatus},
         #{workOrderDescribe},
         #{director},
         #{engineer},
         #{workOrderCompleteTime},
         #{describeType},
         #{rating},
         #{ratingNote},
         #{dealType},
         #{dealNote},
         #{createTime},
         #{escortsPatrol},
         #{escortsStartTime},
         #{escortsCompletetTime},
         #{escortsHandling},
         #{branch},
         #{subBranch},
         #{buffetLine},
         #{vendor}
        )
    </insert>

    <select id="getRepairById" resultType="com.bank.manage.vo.RepairVo">
                select
                    id,
                    work_order_code AS repairCode,
                    work_order_status AS repairStatus,
                    priority_code AS priorityCode
                from t_work_order
                where work_order_code = #{repairCode}
    </select>

    <select id="getEquipmentByCode" resultType="com.bank.manage.vo.EquipmentVo">
            SELECT
                    term.STRTERMNUM terminalCode,
                    device.IDEVTYPE equipmentType,
                    branch.org_code branchOrgId,
                    subbranch.org_code subbranchOrgId,
                    selfsvcbank.STRADDRESS address,
                    device.firstinstalldate installationTime,
                    device.STRDEVMANU deviceVendor
            from dat_term term
            left join dat_device device
            on device.id = term.DEVICEID
            left join dat_branch branch
            on branch.STRBRANCHNUM =device.STRBRANCHNUM
            left join dat_subbranch subbranch
            on subbranch.STRBRANCHNUM = branch.STRBRANCHNUM
            left join dat_selfsvcbank selfsvcbank
            on selfsvcbank.STRBRANCHNUM = subbranch.STRBRANCHNUM
            where term.STRTERMNUM =#{terminalCode}
    </select>

    <select id="getInspectionEquipmentByCode" resultType="com.bank.manage.vo.InspectionEquipmentVo">
                select
                        term.STRTERMNUM terminalCode,
                        device.STRDEVSN sequence,
                        device.IDEVTYPE equipmentType,
                        selfsvcbank.STRSSBNAME name
                from dat_term term
                left join dat_device device
                on device.id =term.DEVICEID
                left join dat_selfsvcbank selfsvcbank
                on selfsvcbank.STRBRANCHNUM = device.STRBRANCHNUM
                left join dat_branch branch
                on branch.STRBRANCHNUM = device.STRBRANCHNUM
                <where>
                <if test="equipmentClass !=null">
                    and device.IDEVCLASS = #{equipmentClass}
                </if>
                <if test="terminalCode !=null">
                    and term.STRTERMNUM= #{terminalCode}
                </if>
                <if test="equipmentType !=null">
                    and device.IDEVTYPE= #{equipmentType}
                </if>
                <if test="orgId !=null">
                    and branch.org_code= #{orgId}
                </if>
                <if test="serviceProviders !=null">
                    and device.STRDEVMANU= #{serviceProviders}
                </if>
                and term.STRTERMNUM in(
                            select
                                terminal_code
                            from t_inspection_records
                    <where>
                        <if test="startTime !=null and endTime != null">
                            and inspection_time between #{startTime}  and  #{endTime}
                        </if>
                    </where>
                    )

                </where>
    </select>

    <select id="getInspectionEquipment" resultType="com.bank.manage.vo.InspectionEquipmentVo">
         select
                        term.STRTERMNUM terminalCode,
                        device.STRDEVSN sequence,
                        device.IDEVTYPE equipmentType,
                        selfsvcbank.STRSSBNAME name
                from dat_term term
                left join dat_device device
                on device.id =term.DEVICEID
                left join dat_selfsvcbank selfsvcbank
                on selfsvcbank.STRBRANCHNUM = device.STRBRANCHNUM
                left join dat_branch branch
                on branch.STRBRANCHNUM = device.STRBRANCHNUM
        <where>
            <if test="equipmentClass !=null">
                and device.IDEVCLASS = #{equipmentClass}
            </if>
            <if test="terminalCode !=null">
                and term.STRTERMNUM= #{terminalCode}
            </if>
            <if test="equipmentType !=null">
                and device.IDEVTYPE= #{equipmentType}
            </if>
            <if test="orgId !=null">
                and branch.org_code= #{orgId}
            </if>
            <if test="serviceProviders !=null">
                and device.STRDEVMANU= #{serviceProviders}
            </if>
            and term.STRTERMNUM not in(
            select
            terminal_code
            from t_inspection_records
            <where>
                <if test="startTime !=null and endTime != null">
                    and inspection_time between #{startTime}  and  #{endTime}
                </if>
            </where>
            )

        </where>
    </select>

    <select id="getDevicesNumber"  resultType="com.bank.manage.vo.DevicesNumberVo">
        select    count(*) totalNumber,
                  ifnull(sum( case when device.ISTATUS ='4' then
                          1
                    end ),0) onlineNumber,
                  ifnull(sum( case when device.ISTATUS ='2' then
                          1
                    end ),0) suspendedNumber,
                  ifnull(sum( case when device.ISTATUS ='5' then
                          1
                    end ),0) faultNumber,
                  ifnull(sum( case when device.ISTATUS ='1' then
                          1
                    end ),0) offlineNumber,
                  round(ifnull(sum( case when device.ISTATUS ='4' then
                          1
                    end )/count(*),0),2) availability
     from dat_device device
     left join dat_branch branch
        on device.STRBRANCHNUM = branch.STRBRANCHNUM
     left join dat_subbranch subbranch
        on  subbranch.STRBRANCHNUM = branch.STRBRANCHNUM
     <where>
         <if test="orgId != null">
             branch.org_code = #{orgId} or subbranch.org_code = #{orgId}
         </if>
     </where>

    </select>

    <select id="getLargerScreen" resultType="com.bank.manage.vo.LargerScreenVo">
            select
                    a.DEVICE_ID id,
                    a.TERMINAL_NUM terminalCode,
                    a.DEVICE_NAME equipmentName,
                    a.`STATUS` status
            from s_device a
            <where>
                <if test="terminalCode != null">
                  and  a.TERMINAL_NUM = #{terminalCode}
                </if>
            </where>
    </select>

    <select id="getPrinterByCode" resultType="com.bank.manage.vo.PrinterVo">
        select
                termstatus.id id,
                termstatus.VMRECEIPTPRINTER stripPrinterStatus,
                termstatus.VMJOURNALPRINTER flowPrinterStatus,
                termstatus.VMSTATEMENTPRINTER reconciliationPrinterStatus,
                termstatus.VMPASSBOOKPRINTER passbookPrinter
        from dat_termstatus termstatus
        where termstatus.STRTERMNUM = #{terminalCode}
    </select>

    <select id="getWorkOrder" resultType="com.bank.manage.vo.WorkOrderVO">
               select
                        t.id id,
                        t.work_order_code workOrderCode,
                        t.terminal_code terminalCode,
                        t.create_time createTime,
                        subbranch.org_code orgId,
                        t.work_order_status status,
                        device.STRDEVMANU vendor,
                        device.STRDEVSN repairCode,
                        t.deal_type way,
                        device.IDEVTYPE repairName,
                        t.engineer engineer
                from t_work_order t
                   left join dat_term term
                on term.STRTERMNUM =t.terminal_code
                   left join dat_device device
                on device.id =term.DEVICEID
                   left join dat_subbranch subbranch
                on subbranch.STRSUBBRANCHNUM = term.STRSUBBRANCHNUM

                <where>
                    <if test="model.workOrderType != null">
                        and t.work_order_type = #{model.workOrderType}
                    </if>
                    <if test="model.orgId != null">
                        and subbranch.org_code= #{model.orgId}
                    </if>
                    <if test="model.vendor != null">
                        and device.STRDEVMANU like concat('%',#{model.vendor},'%')
                    </if>
                    <if test="model.status != null">
                        and t.work_order_status = #{model.status}
                    </if>
                    <if test="model.terminalCode != null">
                        and t.terminal_code = #{model.terminalCode}
                    </if>
                    <if test="model.logUserId != null">
                        and t.create_id = #{model.logUserId}
                    </if>
                </where>
                union all
                select
                    work_order.id id,
                    "" workOrderCode,
                    "" terminalCode,
                    work_order.beginDate createTime,
                    subbranch.org_code orgId,
                    work_order.status status,
                    work_order.deviceManu vendor,
                    work_order.deviceModel repairCode,
                    "" way,
                    work_order.deviceType repairName,
                    "" engineer

                from dat_work_order work_order
                left join dat_subbranch subbranch
                on subbranch.STRSUBBRANCHNUM = work_order.STRSUBBRANCHNUM
                <where>
                    <if test="model.orgId != null">
                        and subbranch.org_code = #{model.orgId}
                    </if>
                    <if test="model.vendor != null">
                        and work_order.deviceManu like concat('%',#{model.vendor},'%')
                    </if>
                    <if test="model.terminalCode != null">
                        and work_order.strTermNum = #{model.terminalCode}
                    </if>
                </where>

    </select>

    <select id="getWorkOrderByMe" resultType="com.bank.manage.vo.WorkOrderVO">
        select
                t.id id,
                t.work_order_code workOrderCode,
                t.terminal_code terminalCode,
                t.create_time createTime,
                subbranch.org_code orgId,
                t.work_order_status status,
                device.STRDEVMANU vendor,
                device.STRDEVSN  repairCode,
                t.deal_type way,
                device.IDEVTYPE repairName,
                t.engineer engineer
        from t_work_order t
        left join dat_term term
        on term.STRTERMNUM =t.terminal_code
        left join dat_device device
        on device.id =term.DEVICEID
        left join dat_subbranch subbranch
        on subbranch.STRSUBBRANCHNUM = term.STRSUBBRANCHNUM
        left join t_work_water water
        on water.word_order_id =t.id
        <where>
            <if test="model.workOrderType != null">
                and t.work_order_type = #{model.workOrderType}
            </if>
            <if test="model.orgId != null">
                and subbranch.org_code= #{model.orgId}
            </if>
            <if test="model.vendor != null">
                and device.STRDEVMANU like concat('%',#{model.vendor},'%')
            </if>
            <if test="model.status != null">
                and t.work_order_status = #{model.status}
            </if>
            <if test="model.terminalCode != null">
                and t.terminal_code = #{model.terminalCode}
            </if>
            <if test="model.logUserId != null">
                and t.create_id  = #{model.logUserId}
            </if>
            and  t.id not in (
              select word_order_id   from t_work_water
            )
        </where>
    </select>

    <select id="getWorkOrderByOther" resultType="com.bank.manage.vo.WorkOrderVO">
        select
            t.id id,
            t.work_order_code workOrderCode,
            t.terminal_code terminalCode,
            t.create_time createTime,
            subbranch.org_code orgId,
            t.work_order_status status,
            device.STRDEVMANU vendor,
            device.STRDEVSN  repairCode,
            t.deal_type way,
            device.IDEVTYPE repairName,
            t.engineer engineer
        from t_work_order t
        left join dat_term term
        on term.STRTERMNUM =t.terminal_code
        left join dat_device device
        on device.id =term.DEVICEID
        left join dat_subbranch subbranch
        on subbranch.STRSUBBRANCHNUM = term.STRSUBBRANCHNUM
        left join t_work_water water
        on water.word_order_id =t.id
        <where>
            <if test="model.workOrderType != null">
                and t.work_order_type = #{model.workOrderType}
            </if>
            <if test="model.orgId != null">
                and subbranch.org_code= #{model.orgId}
            </if>
            <if test="model.vendor != null">
                and device.STRDEVMANU like concat('%',#{model.vendor},'%')
            </if>
            <if test="model.status != null">
                and t.work_order_status = #{model.status}
            </if>
            <if test="model.terminalCode != null">
                and t.terminal_code = #{model.terminalCode}
            </if>
            <if test="model.logUserId != null">
                and t.create_id = #{model.logUserId}
            </if>
            and  t.id  in (
                   select word_order_id   from t_work_water
                   <where>
                       <if test="model.sourceType != null" >
                           and deal_with_type = #{model.sourceType}
                       </if>
                   </where>

            )
        </where>
    </select>




    <select id="getWorkOrderBySystem" resultType="com.bank.manage.vo.WorkOrderVO">
        select
        work_order.id id,
        subbranch.org_code orgId,
        work_order.status status,
        work_order.deviceType repairName,
        work_order.deviceManu vendor,
        work_order.deviceModel repairCode,
        work_order.beginDate createTime

        from dat_work_order work_order
        left join dat_subbranch subbranch
        on subbranch.STRSUBBRANCHNUM = work_order.STRSUBBRANCHNUM

        <where>
            <if test="model.orgId != null">
                and subbranch.org_code = #{model.orgId}
            </if>
            <if test="model.vendor != null">
                and work_order.deviceManu like concat('%',#{model.vendor},'%')
            </if>
            <if test="model.terminalCode != null">
                and work_order.strTermNum = #{model.terminalCode}
            </if>
        </where>
    </select>

    <select id="getBreakWorkOrderByCode" resultType="com.bank.manage.vo.BreakDownWorkOrderVo">
          SELECT
                    t.work_order_code workOrderCode,
                    t.work_order_status workOrderStatus,
                    t.priority_code priorityCode,
                    t.requir_complete_time requirCompleteTime,
                    t.create_name createName,
                    t.create_time createTime,
                    t.work_order_describe workOrderDescribe
            from t_work_order t
            where
                 t.work_order_code = #{repairCode}
    </select>

    <select id="getCompletedWordOrderByCode" resultType="com.bank.manage.vo.CompletedWordOrderVo">
        select
                    a.id id,
                    device.STRDEVMANU deviceVendor,
                    device.STRDEVMODEL deviceModel,
                    termstatus.CASHACCEPTORINFO depositStatus,
                    termstatus.CASHDISPENSERINFO withDrawalsStatus,
                    termstatus.VMCARDREADER readerStatus,
                    termstatus.VMPINPAD passWordStatus,
                    termstatus.VMJOURNALPRINTER flowPrinterStatus,
                    termstatus.VMRECEIPTPRINTER slipPrinterStatus,
                    termstatus.VMSTATEMENTPRINTER reconciliationPrinterStatus,
                    termstatus.VMPASSBOOKPRINTER passbookPrinterStatus ,
                    termstatus.SVCSTATUS serviceStatus,
                    branch.org_code orgId,
                    term.STRTERMADDR address,
                    device.firstinstalldate installationTime,
                    a.terminal_code terminalCode,
                    device.IDEVTYPE,
                    a.director director

            from t_work_order a
               left join dat_term term
            on term.STRTERMNUM = a.terminal_code
               left join dat_device device
            on device.id = term.DEVICEID
               left join dat_termstatus termstatus
            on termstatus.STRTERMNUM = a.terminal_code
               left join dat_branch branch
            on branch.STRBRANCHNUM = device.STRBRANCHNUM

            <where>
                <if test="workOrderCode != null">
                  and  a.work_order_code= #{workOrderCode}
                </if>
                <if test="createId != null">
                    and a.create_id= #{createId}
                </if>
                <if test="createTime != null">
                    and a.create_time = #{createTime}
                </if>
                <if test="workOrderDescribe != null">
                    and a.work_order_describe like concat('%', #{workOrderDescribe},'%')
                </if>
                <if test="escortsPatrol != null">
                    and a.escorts_patrol = #{escortsPatrol}
                </if>
                <if test="requirCompleteTime != null">
                    and a.requir_complete_time = #{requirCompleteTime}
                </if>

            </where>
    </select>

    <select id="getServiceInformationByCode" resultType="com.bank.manage.vo.ServiceInformationsVo">
              select
                        t.vendor deviceVendor,
                        t.director director,
                        t.engineer engineer,
                        t.deal_type dealType,
                        t.work_order_complete_time workOrderCompleteTime,
                        t.escorts_start_time escortsStartTime,
                        t.escorts_complete_time escortsCompleteTime

                from t_work_order t
                where t.work_order_code  = #{repairCode}
    </select>

    <select id="kioskDto" resultType="com.bank.manage.vo.KioskVo">
            select
                    dev.id id,
                    dev.IDEVTYPE equipmentName,
                    dev.ISTATUS status,
                    term.STRTERMNUM terminalCode,
                    term.STRTERMADDR address,
                    term.ORGANIZATION
            from dat_device dev
               left join dat_term term
            on term.DEVICEID = dev.id
           where
                term.ORGANIZATION = #{model.organization}
    </select>

    <select id ="getKioskById" resultType="com.bank.manage.vo.CompletedWordOrderVo">
            select
                device.id id,
                device.STRDEVMANU deviceVendor,
                device.STRDEVMODEL deviceModel,
                termstatus.CASHACCEPTORINFO depositStatus,
                termstatus.CASHDISPENSERINFO withDrawalsStatus,
                termstatus.VMCARDREADER readerStatus,
                termstatus.VMPINPAD passWordStatus,
                termstatus.VMJOURNALPRINTER flowPrinterStatus,
                termstatus.VMRECEIPTPRINTER slipPrinterStatus,
                termstatus.VMSTATEMENTPRINTER reconciliationPrinterStatus,
                termstatus.VMPASSBOOKPRINTER passbookPrinterStatus ,
                termstatus.SVCSTATUS serviceStatus,
                branch.org_code orgId,
                term.STRTERMADDR address,
                device.firstinstalldate installationTime,
                term.STRTERMNUM terminalCode,
                device.IDEVTYPE,
                a.director director

            from dat_device device
               left join dat_term term
            on device.id = term.DEVICEID
               left join dat_termstatus termstatus
            on termstatus.STRTERMNUM = term.STRTERMNUM
               left join dat_branch branch
            on branch.STRBRANCHNUM = device.STRBRANCHNUM
               left join t_work_order a
            on a.terminal_code = term.STRTERMNUM
            where device.id = #{id}
    </select>
</mapper>
